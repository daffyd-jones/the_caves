use crate::enums::{Cells, Door, EnvInter, NPCWrap, Settle};
use crate::enums::{ShopItem, Shops};
use crate::item::Item;
use crate::npc::ShopNPC;
use crate::settlement::parse_map;

use rand::prelude::SliceRandom;

//use serde::{Deserialize, Serialize};
//use serde_json::Result;
//use serde_json::Value;
// use std::fs;

use std::collections::HashMap;

const OBSIDIAN_ITEM_STALL_1: &str = r#"ShopNPC|HealthPotion Salve IronLongsword WoodenStaff HealthPotion Salve IronLongsword WoodenStaff HealthPotion Salve IronLongsword WoodenStaff HealthPotion Salve IronLongsword WoodenStaff|Null
_________________│______
_________________│______
___─┬─___─┬─____________
___o│o___o│o_____│______
___o│o___o│o_____│@_____
___─┼─___─┼─_____└──────
___o│o___o│o____________
___o│o___o│o____________
___─┴─___─┴─____________
________________________
________________________
________________________
"#;

const OBSIDIAN_HERBALIST_STALL_1: &str = r#"ShopNPC|HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve|Null
________________________
_⚱__ṑṑ_ṑṑṑ______________
_ṑ⚱________─┬─___─┬─____
_ṑṑ________o│o___o│o____
_ṑ_________o│o___o│o____
___________─┼─___─┼─____
___________o│o___o│o____
──_──┐_____o│o___o│o____
_____│_____─┴─___─┴─____
___@_│__________________
__π⑁_│℧___________ቋ_____
_____│__________________
"#;

const OBSIDIAN_CLINIC_STALL_1: &str = r#"CommNPC|Null|Null
________________________
________________________
__┌───┐__________┌───┐__
__│_🁢______________🁢_│__
__├───┤__________├───┤__
__│_🁢______________🁢_│__
__├───┤__________├───┤__
__│_🁢______________🁢_│__
__└───┘__________└───┘__
_____┌───┐________⌹⌹⌹___
_┌───┘_@_│______________
_│_______│______________
"#;

const OBSIDIAN_CANTEEN_STALL_1: &str = r#"CommNPC|Null|Null
________________________
________________________
____Ⴙπ⑁___π⑁______──┐___
____________________│___
_____π⑁__Ⴙπ_________│___
____________________│___
____Ⴙπ____π⑁________│___
__________________@_│___
____Ⴙπ⑁__Ⴙπ_________│___
________________________
________________________
________________________
"#;

const OBSIDIAN_FILLER_1: &str = r#"Null|Null|Null
________│_______________
_______ቋ│_______________
________________________
___≡≡≡≡≡│_______________
────────┘_______________
________________________
_____________┌─_________
──────______⌹│__________
__⌹⌹⌹_______⌹│🝻_________
_____________│__________
_____________│≡≡________
_____________│__________
"#;

const OBSIDIAN_OFFICE_1: &str = r#"Null|Null|Null
________│_______________
________________________
________│______Һπ│π⑁____
────────┘_____───┼───___
_______________Һπ│π⑁____
________________________
________________________
________________________
____Һπ│π⑁______Һπ│π⑁____
___───┼───____───┼───___
____Һπ│π⑁______Һπ│π⑁____
________________________
"#;

const OBSIDIAN_DORM: &str = r#"Null|Null|Null
________________________
________________________
________┌───┬───┐_______
________│_🁢_│_🁢_│_______
____┌───┴─_─┴─_─┴───┐___
____│_🁢___________🁢_│___
____├───┤_______├───┤___
____│_🁢___________🁢_│___
____├───┤_______├───┤___
____│_🁢___________🁢_│___
____└───┘_______└───┘___
________________________
________________________
___┌───┐_______┌───┐____
___│_🁢___________🁢_│____
___├───┤_______├───┤____
___│_🁢___________🁢_│____
___├───┤_______├───┤____
___│_🁢___________🁢_│____
___└───┬─_─┬─_─┬───┘____
_______│_🁢_│_🁢_│________
_______└───┴───┘________
________________________
________________________
"#;

const OBSIDIAN_WALLS_BOTTOM: &str = r#"
######################################################################################____######################################
######################################################################################____######################################
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨___▨__▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨__▧___▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨___▨__▧________________________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨__▧___▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║ஃ_______▨___▨__▧_______ஃ║_______________________####
####_______________________║_______________________║_______________________║Ÿ_______▨_▩__▩_▧_______Ÿ║_______________________####
####══════════__═══════════╩═══════════__══════════╩═══════════__══════════╝________▨__▧___▧________╠═══════════════════════####
####________________________________________________________________________________▨_▩__▩_▧________║_______________________####
####________________________________________________________________________________________________║_______________________####
####____________________________🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫__🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫____║_______________________####
####▨_▨_▨_▨_▨_▨_▨_▨_▨_▨_▨_▨_▨___🀫_🀙_________🀆___🀆___🀆___🀆___🀆______🀆___🀆___🀆___🀆___🀆_________🀙_🀫____║_______________________####
####▩___▩___▩___▩___▩___▩___▩___🀫___🀙_____🀆____🀆_🀆_🀆_🀆_🀆_🀆_🀆_🀆____🀆_🀆_🀆_🀆_🀆_🀆_🀆_🀆_🀆__🀆_____🀙___🀫____║_______________________####
__________▧_______▧_______▧_____🀫_____🀙_🀆_____🀆___🀆___🀆___🀆___🀆__🀆___🀆___🀆___🀆___🀆_____🀆_🀙_____🀫____________________________####
______▨_______▨_______▨_________🀫_____🀆_🀙___________________┌──────┐___________________🀙_🀆_____🀫____║_______________________####
####▩___▩___▩___▩___▩___▩___▩___🀫___🀆_____🀙_______╔═════════╧══════╧═════════╗_______🀙_____🀆___🀫____║_______________________####
####▧_▧_▧_▧_▧_▧_▧_▧_▧_▧_▧_▧_▧___🀫_🀆_________🀙_____║__________________________║_____🀙_________🀆_🀫____║_______________________####
####____________________________🀫___🀆_____🀙_______║__________________________║_______🀙_____🀆___🀫____║_______________________####
####____________________________🀫_____🀆_🀙_________║__________________________║_________🀙_🀆_____🀫____║_______________________####
####____________________________🀫_____🀙_🀆_________╚══════════════════════════╝_________🀆_🀙_____🀫____╠═══════════════════════####
####═══════════════════════╗ঌ___🀫___🀙_____🀆__________________________________________🀆_____🀙___🀫___ঌ║_______________________####
####_______________________║Ť___🀫_🀙_________🀆______________________________________🀆_________🀙_🀫___Ť║_______________________####
####_______________________║____🀫___🀙_______🀆______________________________________🀆_______🀙___🀫____║_______________________####
####_______________________║____🀫_____🀙_____🀆_└──────────────┘____└──────────────┘_🀆_____🀙_____🀫____║_______________________####
####_______________________║____🀫_______🀙_🀆__________________________________________🀆_🀙_______🀫____║_______________________####
####_______________________║____🀫_______🀆_🀙___└──────────────┘____└──────────────┘___🀙_🀆_______🀫____________________________####
####____________________________🀫_____🀆_____🀙______________________________________🀙_____🀆_____🀫____║_______________________####
####_______________________║____🀫___🀆_______🀙_└──────────────┘____└──────────────┘_🀙_______🀆___🀫____║_______________________####
####_______________________║____🀫_🀆_________🀙______________________________________🀙_________🀆_🀫____║_______________________####
####_______________________║܀___🀫___🀆_______🀙_└──────────────┘____└──────────────┘_🀙_______🀆___🀫___܀║_______________________####
####_______________________║Ŧ___🀫_____🀆___🀙__________________________________________🀙___🀆_____🀫___Ŧ║_______________________####
####_______________________║____🀫_______🀙_____└──────────────┘____└──────────────┘_____🀙_______🀫____║_______________________####
####_______________________║____🀫_____🀙___🀆_____🀆___🀆___🀆___🀆______🀆___🀆___🀆___🀆_____🀆___🀙_____🀫____╠═══════════════════════####
####_______________________║____🀫___🀙_______🀆__🀆_🀆_🀆_🀆_🀆_🀆_🀆_🀆____🀆_🀆_🀆_🀆_🀆_🀆_🀆_🀆__🀆_______🀙___🀫____║_______________________####
####_______________________║____🀫_🀙___________🀆___🀆___🀆___🀆___🀆__🀆___🀆___🀆___🀆___🀆___________🀙_🀫____║_______________________####
####_______________________║____🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫__🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫_🀫____║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║_________▩_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▧▨_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▩_________║_______________________####
####_______________________║_________▨____________________________________________________▧_________________________________####
####_______________________║_________▧____________________________________________________▨_________║_______________________####
####_______________________║_________▨____________________________________________________▧_________║_______________________####
####_______________________║_________▧____________________________________________________▨_________║_______________________####
####_______________________║_______ஃ_▨____________________________________________________▧_ஃ_______║_______________________####
####_______________________║_______Ŧ_▧____________________________________________________▨_Ŧ_______║_______________________####
##############################################################____##############################################################
##############################################################____##############################################################
"#;

const OOBSIDIAN_WALLS_BOTTOM: &str = r#"
######################################################################################____######################################
######################################################################################____######################################
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨___▨__▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨__▧___▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨___▨__▧________________________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨__▧___▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####_______________________║_______________________║_______________________║________▨___▨__▧________║_______________________####
####_______________________║_______________________║_______________________║________▨_▩__▩_▧________║_______________________####
####══════════__═══════════╩═══════════__══════════╩═══════════__══════════╝________▨______▧________╠═══════════════════════####
####________________________________________________________________________________________________║_______________________####
####________________________________________________________________________________________________║_______________________####
####________________________________________________________________________________________________║_______________________####
####▨_▨_▨_▨_▨_▨_▨_▨_▨_▨_▨_▨_________________________________________________________________________║_______________________####
####▩___▩___▩___▩___▩___▩___________________________________________________________________________║_______________________####
__________▧_______▧_________________________________________________________________________________________________________####
______▨_______▨_______▨_____________________________________┌──────┐________________________________║_______________________####
####▩___▩___▩___▩___▩___▩_________________________╔═════════╧══════╧═════════╗______________________║_______________________####
####▧_▧_▧_▧_▧_▧_▧_▧_▧_▧_▧_▧_______________________║__________________________║______________________║_______________________####
####______________________________________________║__________________________║______________________║_______________________####
####______________________________________________║__________________________║______________________║_______________________####
####______________________________________________╚══════════════════════════╝______________________╠═══════════════════════####
####═══════════════════════╗________________________________________________________________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║__________________└──────────────┘____└──────────────┘__________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║__________________└──────────────┘____└──────────────┘__________________________________________####
####________________________________________________________________________________________________║_______________________####
####_______________________║__________________└──────────────┘____└──────────────┘__________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║__________________└──────────────┘____└──────────────┘__________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║__________________└──────────────┘____└──────────────┘__________________║_______________________####
####_______________________║________________________________________________________________________╠═══════════════════════####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║________________________________________________________________________║_______________________####
####_______________________║_________▩_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▧▨_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▧_▨_▩_________║_______________________####
####_______________________║_________▨____________________________________________________▧_________________________________####
####_______________________║_________▧____________________________________________________▨_________║_______________________####
####_______________________║_________▨____________________________________________________▧_________║_______________________####
####_______________________║_________▧____________________________________________________▨_________║_______________________####
####_______________________║_________▨____________________________________________________▧_________║_______________________####
####_______________________║_________▧____________________________________________________▨_________║_______________________####
##############################################################____##############################################################
##############################################################____##############################################################
"#;

pub fn add_obsidian_walls(mut map: Vec<Vec<Cells>>, left: bool) -> Vec<Vec<Cells>> {
    let walls = match left {
        true => OBSIDIAN_WALLS_BOTTOM,
        false => OBSIDIAN_WALLS_BOTTOM,
        // false => GUILD_WALLS_RIGHT,
        _ => todo!(),
    };

    for (y, line) in walls.lines().skip(1).enumerate() {
        for (x, ch) in line.chars().enumerate() {
            if ch == '_' {
                continue;
            };
            map[y][x] = match ch {
                '═' => Cells::MwH,
                '║' => Cells::MwV,
                '╣' => Cells::MwVL,
                '╠' => Cells::MwVR,
                '╩' => Cells::MwHU,
                '╦' => Cells::MwHD,
                '╝' => Cells::MwUL,
                '╚' => Cells::MwUR,
                '╗' => Cells::MwDL,
                '╔' => Cells::MwDR,
                '╤' => Cells::BsHD,
                '╧' => Cells::BsHU,
                '┐' => Cells::SwDL,
                '┌' => Cells::SwDR,
                '┘' => Cells::SwUL,
                '└' => Cells::SwUR,
                '─' => Cells::SwH,
                '▧' => Cells::Tile1,
                '▨' => Cells::Tile2,
                '▩' => Cells::Tile3,
                '#' => Cells::Wall,
                'Һ' => Cells::ChairRight1,
                'Ⴙ' => Cells::ChairRight2,
                'ж' => Cells::Firewood,
                'ঌ' => Cells::FireSmoke,
                '܀' => Cells::FireDiamond,
                'ஃ' => Cells::FireTri,
                'Ŧ' => Cells::Stand1,
                'Ÿ' => Cells::Stand2,
                'Ť' => Cells::Stand3,
                'ƃ' => Cells::StandBL,
                'ƌ' => Cells::StandDL,
                'Ƃ' => Cells::StandBS,
                'Ƌ' => Cells::StandDS,
                '◍' => Cells::CircleVL,
                '⏣' => Cells::CircleHex,
                '⌬' => Cells::CircleC,
                '⌹' => Cells::Drawers,
                '⌸' => Cells::Shelves,
                '⚱' => Cells::Vase,
                '𜲄' => Cells::LadderV,
                '𜲅' => Cells::LadderH,
                '𜲐' => Cells::TickV,
                '𜲑' => Cells::TickH,
                'ቋ' => Cells::Tech1,
                '🝻' => Cells::Tech2,
                '🜟' => Cells::Tech3,
                'ଏ' => Cells::Tech4,
                'Ҧ' => Cells::Tech5,
                'Ҹ' => Cells::Tech6,
                'Ҵ' => Cells::Tech7,
                'ౝ' => Cells::Tech8,
                '𜰔' => Cells::Tech9,
                '𜰓' => Cells::Tech10,
                '𜰉' => Cells::Tech11,
                '𜰊' => Cells::Tech12,
                '⛀' => Cells::Tech13,
                '⛁' => Cells::Tech14,
                '⛂' => Cells::Tech15,
                '⛃' => Cells::Tech16,
                'Ⴉ' => Cells::Tech17,
                'ቖ' => Cells::Relic1,
                'ቷ' => Cells::OldWall1,
                'ቿ' => Cells::OldWall2,
                'ቨ' => Cells::OldWall3,
                'ቩ' => Cells::OldWall4,
                'ቭ' => Cells::OldWall5,
                '🀫' => Cells::CardTile1,
                '🀘' => Cells::CardTile2,
                '🀆' => Cells::CardTile3,
                '🀙' => Cells::CardTile4,
                _ => todo!(),
            };
        }
    }
    map
}

const OBSIDIAN_ITEM_STALLS: [&str; 1] = [OBSIDIAN_ITEM_STALL_1];
const OBSIDIAN_CLINIC_STALLS: [&str; 1] = [OBSIDIAN_CLINIC_STALL_1];
const OBSIDIAN_HERBALIST_STALLS: [&str; 1] = [OBSIDIAN_HERBALIST_STALL_1];
const OBSIDIAN_CANTEEN_STALLS: [&str; 1] = [OBSIDIAN_CANTEEN_STALL_1];
const OBSIDIAN_FILLERS: [&str; 1] = [OBSIDIAN_FILLER_1];
const OBSIDIAN_OFFICES: [&str; 1] = [OBSIDIAN_OFFICE_1];
const OBSIDIAN_DORMS: [&str; 1] = [OBSIDIAN_DORM];

pub fn build_obsidian_settle() -> (
    Vec<Vec<Cells>>,
    HashMap<(usize, usize), NPCWrap>,
    HashMap<(usize, usize), ShopItem>,
    HashMap<(usize, usize), Item>,
    HashMap<(usize, usize), EnvInter>,
    HashMap<(usize, usize), ShopNPC>,
) {
    let mut rng = rand::thread_rng();
    // let cells = vec![vec![Cells::Empty; 128]; 52];
    let face_top = &false;
    // let face_top = [true, false].choose(&mut rng).unwrap_or(&true);
    let mut blocks: Vec<u8> = (1..8).collect();
    blocks.shuffle(&mut rng);

    let (item_map, item_npcs, item_sitems, item_items, item_env_inter, item_shop_npcs) = parse_map(
        OBSIDIAN_ITEM_STALLS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_ITEM_STALLS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Item,
    );
    let (clinic_map, clinic_npcs, clinic_sitems, clinic_items, clinic_env_inter, clinic_shop_npcs) =
        parse_map(
            OBSIDIAN_CLINIC_STALLS
                .choose(&mut rng)
                .unwrap_or(&OBSIDIAN_CLINIC_STALLS[0]),
            vec![vec![Cells::Null; 24]; 12],
            Shops::Null,
        );
    let (
        herbalist_map,
        herbalist_npcs,
        herbalist_sitems,
        herbalist_items,
        herbalist_env_inter,
        herbalist_shop_npcs,
    ) = parse_map(
        OBSIDIAN_HERBALIST_STALLS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_HERBALIST_STALLS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Herbalist,
    );
    let (
        canteen_map,
        canteen_npcs,
        canteen_sitems,
        canteen_items,
        canteen_env_inter,
        canteen_shop_npcs,
    ) = parse_map(
        OBSIDIAN_CANTEEN_STALLS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_CANTEEN_STALLS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Null,
    );
    let (
        filler1_map,
        filler1_npcs,
        filler1_sitems,
        filler1_items,
        filler1_env_inter,
        filler1_shop_npcs,
    ) = parse_map(
        OBSIDIAN_FILLERS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_FILLERS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Null,
    );
    let (
        filler2_map,
        filler2_npcs,
        filler2_sitems,
        filler2_items,
        filler2_env_inter,
        filler2_shop_npcs,
    ) = parse_map(
        OBSIDIAN_FILLERS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_FILLERS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Null,
    );
    let (office_map, office_npcs, office_sitems, office_items, office_env_inter, office_shop_npcs) =
        parse_map(
            OBSIDIAN_OFFICES
                .choose(&mut rng)
                .unwrap_or(&OBSIDIAN_OFFICES[0]),
            vec![vec![Cells::Null; 24]; 12],
            Shops::Null,
        );
    let (dorm_map, dorm_npcs, dorm_sitems, dorm_items, dorm_env_inter, dorm_shop_npcs) = parse_map(
        OBSIDIAN_DORMS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_DORMS[0]),
        vec![vec![Cells::Null; 24]; 24],
        Shops::Null,
    );

    let (b1_map, b1_npcs, b1_sitems, b1_items, b1_env_inter) = place_obsidion_parts(
        vec![vec![Cells::Null; 128]; 52],
        item_map,
        item_npcs,
        item_sitems,
        item_items,
        item_env_inter,
        blocks[0],
        *face_top,
    );
    let (b2_map, b2_npcs, b2_sitems, b2_items, b2_env_inter) = place_obsidion_parts(
        b1_map.clone(),
        clinic_map,
        clinic_npcs,
        clinic_sitems,
        clinic_items,
        clinic_env_inter,
        blocks[1],
        *face_top,
    );
    let (b3_map, b3_npcs, b3_sitems, b3_items, b3_env_inter) = place_obsidion_parts(
        b2_map.clone(),
        herbalist_map,
        herbalist_npcs,
        herbalist_sitems,
        herbalist_items,
        herbalist_env_inter,
        blocks[2],
        *face_top,
    );
    let (b4_map, b4_npcs, b4_sitems, b4_items, b4_env_inter) = place_obsidion_parts(
        b3_map.clone(),
        canteen_map,
        canteen_npcs,
        canteen_sitems,
        canteen_items,
        canteen_env_inter,
        blocks[3],
        *face_top,
    );
    let (b5_map, b5_npcs, b5_sitems, b5_items, b5_env_inter) = place_obsidion_parts(
        b4_map.clone(),
        filler1_map,
        filler1_npcs,
        filler1_sitems,
        filler1_items,
        filler1_env_inter,
        blocks[4],
        *face_top,
    );
    let (b6_map, b6_npcs, b6_sitems, b6_items, b6_env_inter) = place_obsidion_parts(
        b5_map.clone(),
        filler2_map,
        filler2_npcs,
        filler2_sitems,
        filler2_items,
        filler2_env_inter,
        blocks[5],
        *face_top,
    );
    let (b7_map, b7_npcs, b7_sitems, b7_items, b7_env_inter) = place_obsidion_parts(
        b6_map.clone(),
        office_map,
        office_npcs,
        office_sitems,
        office_items,
        office_env_inter,
        blocks[6],
        *face_top,
    );
    let (b8_map, b8_npcs, b8_sitems, b8_items, b8_env_inter) = place_obsidion_parts(
        b7_map.clone(),
        dorm_map,
        dorm_npcs,
        dorm_sitems,
        dorm_items,
        dorm_env_inter,
        8,
        *face_top,
    );

    let final_map = add_obsidian_walls(b8_map, *face_top);

    let mut final_npcs = HashMap::new();
    let mut final_sitems = HashMap::new();
    let mut final_items = HashMap::new();
    let mut final_env_inter = HashMap::new();
    let mut final_shop_npcs = HashMap::new();
    final_npcs.extend(b1_npcs);
    final_npcs.extend(b2_npcs);
    final_npcs.extend(b3_npcs);
    final_npcs.extend(b4_npcs);
    final_npcs.extend(b5_npcs);
    final_npcs.extend(b6_npcs);
    final_npcs.extend(b7_npcs);
    final_npcs.extend(b8_npcs);
    final_sitems.extend(b1_sitems);
    final_sitems.extend(b2_sitems);
    final_sitems.extend(b3_sitems);
    final_sitems.extend(b4_sitems);
    final_sitems.extend(b5_sitems);
    final_sitems.extend(b6_sitems);
    final_sitems.extend(b7_sitems);
    final_sitems.extend(b8_sitems);
    final_items.extend(b1_items);
    final_items.extend(b2_items);
    final_items.extend(b3_items);
    final_items.extend(b4_items);
    final_items.extend(b5_items);
    final_items.extend(b6_items);
    final_items.extend(b7_items);
    final_items.extend(b8_items);
    final_env_inter.extend(b1_env_inter);
    final_env_inter.extend(b2_env_inter);
    final_env_inter.extend(b3_env_inter);
    final_env_inter.extend(b4_env_inter);
    final_env_inter.extend(b5_env_inter);
    final_env_inter.extend(b6_env_inter);
    final_env_inter.extend(b7_env_inter);
    final_env_inter.extend(b8_env_inter);
    final_shop_npcs.extend(item_shop_npcs);
    final_shop_npcs.extend(clinic_shop_npcs);
    final_shop_npcs.extend(herbalist_shop_npcs);
    final_shop_npcs.extend(canteen_shop_npcs);
    final_shop_npcs.extend(filler1_shop_npcs);
    final_shop_npcs.extend(filler2_shop_npcs);
    final_shop_npcs.extend(office_shop_npcs);
    final_shop_npcs.extend(dorm_shop_npcs);
    (
        final_map,
        final_npcs,
        final_sitems,
        final_items,
        final_env_inter,
        final_shop_npcs,
    )
}

fn place_obsidion_parts(
    mut map: Vec<Vec<Cells>>,
    part: Vec<Vec<Cells>>,
    npcs: HashMap<(usize, usize), NPCWrap>,
    sitems: HashMap<(usize, usize), ShopItem>,
    items: HashMap<(usize, usize), Item>,
    env_inter: HashMap<(usize, usize), EnvInter>,
    block: u8,
    top: bool,
) -> (
    Vec<Vec<Cells>>,
    HashMap<(usize, usize), NPCWrap>,
    HashMap<(usize, usize), ShopItem>,
    HashMap<(usize, usize), Item>,
    HashMap<(usize, usize), EnvInter>,
) {
    let (sx, sy) = if top {
        match block {
            1 => (4, 2),
            2 => (4, 14),
            3 => (4, 26),
            4 => (4, 38),
            5 => (52, 38),
            6 => (76, 38),
            7 => (100, 38),
            8 => (100, 2),
            _ => {
                log::info!("small parts error");
                (0, 0)
            }
        }
    } else {
        match block {
            1 => (4, 2),
            2 => (28, 2),
            3 => (52, 2),
            4 => (100, 2),
            5 => (100, 14),
            6 => (100, 26),
            7 => (100, 38),
            8 => (4, 26),
            _ => {
                log::info!("guild parts error");
                (0, 0)
            }
        }
    };

    for j in 0..part.len() {
        for i in 0..part[0].len() {
            map[j + &sy][i + &sx] = part[j][i];
        }
    }
    let mut new_npcs = HashMap::new();
    for (npos, npc) in npcs {
        new_npcs.insert(((npos.0 + &sx), (npos.1 + &sy)), npc);
    }
    let mut new_sitems = HashMap::new();
    for (ipos, item) in sitems {
        new_sitems.insert(((ipos.0 + &sx), (ipos.1 + &sy)), item);
    }
    let mut new_items = HashMap::new();
    for (ipos, mut item) in items {
        item.set_pos(((ipos.0 + &sx), (ipos.1 + &sy)));
        new_items.insert(((ipos.0 + &sx), (ipos.1 + &sy)), item);
    }
    let mut new_env_inter = HashMap::new();
    for (epos, env) in env_inter.clone() {
        new_env_inter.insert(((epos.0 + &sx), (epos.1 + &sy)), env);
    }

    (map, new_npcs, new_sitems, new_items, new_env_inter)
}
