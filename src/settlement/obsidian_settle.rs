use crate::enums::{Cells, Door, EnvInter, NPCWrap, Settle};
use crate::enums::{ShopItem, Shops};
use crate::item::Item;
use crate::npc::ShopNPC;
use crate::settlement::parse_map;

use rand::prelude::SliceRandom;

//use serde::{Deserialize, Serialize};
//use serde_json::Result;
//use serde_json::Value;
// use std::fs;

use std::collections::HashMap;

const OBSIDIAN_ITEM_STALL_1: &str = r#"ShopNPC|HealthPotion Salve IronLongsword WoodenStaff HealthPotion Salve IronLongsword WoodenStaff HealthPotion Salve IronLongsword WoodenStaff HealthPotion Salve IronLongsword WoodenStaff|Null
_________________â”‚______
_________________â”‚______
___â”€â”¬â”€___â”€â”¬â”€____________
___oâ”‚o___oâ”‚o_____â”‚______
___oâ”‚o___oâ”‚o_____â”‚@_____
___â”€â”¼â”€___â”€â”¼â”€_____â””â”€â”€â”€â”€â”€â”€
___oâ”‚o___oâ”‚o____________
___oâ”‚o___oâ”‚o____________
___â”€â”´â”€___â”€â”´â”€____________
________________________
________________________
________________________
"#;

const OBSIDIAN_HERBALIST_STALL_1: &str = r#"ShopNPC|HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve HealthPotion Salve|Null
________________________
_âš±__á¹‘á¹‘_á¹‘á¹‘á¹‘______________
_á¹‘âš±________â”€â”¬â”€___â”€â”¬â”€____
_á¹‘á¹‘________oâ”‚o___oâ”‚o____
_á¹‘_________oâ”‚o___oâ”‚o____
___________â”€â”¼â”€___â”€â”¼â”€____
___________oâ”‚o___oâ”‚o____
â”€â”€_â”€â”€â”_____oâ”‚o___oâ”‚o____
_____â”‚_____â”€â”´â”€___â”€â”´â”€____
___@_â”‚__________________
__Ï€â‘_â”‚â„§___________á‰‹_____
_____â”‚__________________
"#;

const OBSIDIAN_CLINIC_STALL_1: &str = r#"CommNPC|Null|Null
________________________
________________________
__â”Œâ”€â”€â”€â”__________â”Œâ”€â”€â”€â”__
__â”‚_ğŸ¢______________ğŸ¢_â”‚__
__â”œâ”€â”€â”€â”¤__________â”œâ”€â”€â”€â”¤__
__â”‚_ğŸ¢______________ğŸ¢_â”‚__
__â”œâ”€â”€â”€â”¤__________â”œâ”€â”€â”€â”¤__
__â”‚_ğŸ¢______________ğŸ¢_â”‚__
__â””â”€â”€â”€â”˜__________â””â”€â”€â”€â”˜__
_____â”Œâ”€â”€â”€â”________âŒ¹âŒ¹âŒ¹___
_â”Œâ”€â”€â”€â”˜_@_â”‚______________
_â”‚_______â”‚______________
"#;

const OBSIDIAN_CANTEEN_STALL_1: &str = r#"CommNPC|Null|Null
________________________
________________________
____á‚¹Ï€â‘___Ï€â‘______â”€â”€â”___
____________________â”‚___
_____Ï€â‘__á‚¹Ï€_________â”‚___
____________________â”‚___
____á‚¹Ï€____Ï€â‘________â”‚___
__________________@_â”‚___
____á‚¹Ï€â‘__á‚¹Ï€_________â”‚___
________________________
________________________
________________________
"#;

const OBSIDIAN_FILLER_1: &str = r#"Null|Null|Null
________â”‚_______________
_______á‰‹â”‚_______________
________________________
___â‰¡â‰¡â‰¡â‰¡â‰¡â”‚_______________
â”€â”€â”€â”€â”€â”€â”€â”€â”˜_______________
________________________
_____________â”Œâ”€_________
â”€â”€â”€â”€â”€â”€______âŒ¹â”‚__________
__âŒ¹âŒ¹âŒ¹_______âŒ¹â”‚ğŸ»_________
_____________â”‚__________
_____________â”‚â‰¡â‰¡________
_____________â”‚__________
"#;

const OBSIDIAN_OFFICE_1: &str = r#"Null|Null|Null
________â”‚_______________
________________________
________â”‚______ÒºÏ€â”‚Ï€â‘____
â”€â”€â”€â”€â”€â”€â”€â”€â”˜_____â”€â”€â”€â”¼â”€â”€â”€___
_______________ÒºÏ€â”‚Ï€â‘____
________________________
________________________
________________________
____ÒºÏ€â”‚Ï€â‘______ÒºÏ€â”‚Ï€â‘____
___â”€â”€â”€â”¼â”€â”€â”€____â”€â”€â”€â”¼â”€â”€â”€___
____ÒºÏ€â”‚Ï€â‘______ÒºÏ€â”‚Ï€â‘____
________________________
"#;

const OBSIDIAN_DORM: &str = r#"Null|Null|Null
________________________
________________________
________â”Œâ”€â”€â”€â”¬â”€â”€â”€â”_______
________â”‚_ğŸ¢_â”‚_ğŸ¢_â”‚_______
____â”Œâ”€â”€â”€â”´â”€_â”€â”´â”€_â”€â”´â”€â”€â”€â”___
____â”‚_ğŸ¢___________ğŸ¢_â”‚___
____â”œâ”€â”€â”€â”¤_______â”œâ”€â”€â”€â”¤___
____â”‚_ğŸ¢___________ğŸ¢_â”‚___
____â”œâ”€â”€â”€â”¤_______â”œâ”€â”€â”€â”¤___
____â”‚_ğŸ¢___________ğŸ¢_â”‚___
____â””â”€â”€â”€â”˜_______â””â”€â”€â”€â”˜___
________________________
________________________
___â”Œâ”€â”€â”€â”_______â”Œâ”€â”€â”€â”____
___â”‚_ğŸ¢___________ğŸ¢_â”‚____
___â”œâ”€â”€â”€â”¤_______â”œâ”€â”€â”€â”¤____
___â”‚_ğŸ¢___________ğŸ¢_â”‚____
___â”œâ”€â”€â”€â”¤_______â”œâ”€â”€â”€â”¤____
___â”‚_ğŸ¢___________ğŸ¢_â”‚____
___â””â”€â”€â”€â”¬â”€_â”€â”¬â”€_â”€â”¬â”€â”€â”€â”˜____
_______â”‚_ğŸ¢_â”‚_ğŸ¢_â”‚________
_______â””â”€â”€â”€â”´â”€â”€â”€â”˜________
________________________
________________________
"#;

const OBSIDIAN_WALLS_BOTTOM: &str = r#"
######################################################################################____######################################
######################################################################################____######################################
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨___â–¨__â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨__â–§___â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨___â–¨__â–§________________________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨__â–§___â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘à®ƒ_______â–¨___â–¨__â–§_______à®ƒâ•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘Å¸_______â–¨_â–©__â–©_â–§_______Å¸â•‘_______________________####
####â•â•â•â•â•â•â•â•â•â•__â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•__â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•__â•â•â•â•â•â•â•â•â•â•â•________â–¨__â–§___â–§________â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•####
####________________________________________________________________________________â–¨_â–©__â–©_â–§________â•‘_______________________####
####________________________________________________________________________________________________â•‘_______________________####
####____________________________ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«__ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«____â•‘_______________________####
####â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨___ğŸ€«_ğŸ€™_________ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†______ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†_________ğŸ€™_ğŸ€«____â•‘_______________________####
####â–©___â–©___â–©___â–©___â–©___â–©___â–©___ğŸ€«___ğŸ€™_____ğŸ€†____ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†____ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†__ğŸ€†_____ğŸ€™___ğŸ€«____â•‘_______________________####
__________â–§_______â–§_______â–§_____ğŸ€«_____ğŸ€™_ğŸ€†_____ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†__ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†_____ğŸ€†_ğŸ€™_____ğŸ€«____________________________####
______â–¨_______â–¨_______â–¨_________ğŸ€«_____ğŸ€†_ğŸ€™___________________â”Œâ”€â”€â”€â”€â”€â”€â”___________________ğŸ€™_ğŸ€†_____ğŸ€«____â•‘_______________________####
####â–©___â–©___â–©___â–©___â–©___â–©___â–©___ğŸ€«___ğŸ€†_____ğŸ€™_______â•”â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•—_______ğŸ€™_____ğŸ€†___ğŸ€«____â•‘_______________________####
####â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§___ğŸ€«_ğŸ€†_________ğŸ€™_____â•‘__________________________â•‘_____ğŸ€™_________ğŸ€†_ğŸ€«____â•‘_______________________####
####____________________________ğŸ€«___ğŸ€†_____ğŸ€™_______â•‘__________________________â•‘_______ğŸ€™_____ğŸ€†___ğŸ€«____â•‘_______________________####
####____________________________ğŸ€«_____ğŸ€†_ğŸ€™_________â•‘__________________________â•‘_________ğŸ€™_ğŸ€†_____ğŸ€«____â•‘_______________________####
####____________________________ğŸ€«_____ğŸ€™_ğŸ€†_________â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•_________ğŸ€†_ğŸ€™_____ğŸ€«____â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•####
####â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—à¦Œ___ğŸ€«___ğŸ€™_____ğŸ€†__________________________________________ğŸ€†_____ğŸ€™___ğŸ€«___à¦Œâ•‘_______________________####
####_______________________â•‘Å¤___ğŸ€«_ğŸ€™_________ğŸ€†______________________________________ğŸ€†_________ğŸ€™_ğŸ€«___Å¤â•‘_______________________####
####_______________________â•‘____ğŸ€«___ğŸ€™_______ğŸ€†______________________________________ğŸ€†_______ğŸ€™___ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_____ğŸ€™_____ğŸ€†_â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜_ğŸ€†_____ğŸ€™_____ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_______ğŸ€™_ğŸ€†__________________________________________ğŸ€†_ğŸ€™_______ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_______ğŸ€†_ğŸ€™___â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜___ğŸ€™_ğŸ€†_______ğŸ€«____________________________####
####____________________________ğŸ€«_____ğŸ€†_____ğŸ€™______________________________________ğŸ€™_____ğŸ€†_____ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«___ğŸ€†_______ğŸ€™_â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜_ğŸ€™_______ğŸ€†___ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_ğŸ€†_________ğŸ€™______________________________________ğŸ€™_________ğŸ€†_ğŸ€«____â•‘_______________________####
####_______________________â•‘Ü€___ğŸ€«___ğŸ€†_______ğŸ€™_â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜_ğŸ€™_______ğŸ€†___ğŸ€«___Ü€â•‘_______________________####
####_______________________â•‘Å¦___ğŸ€«_____ğŸ€†___ğŸ€™__________________________________________ğŸ€™___ğŸ€†_____ğŸ€«___Å¦â•‘_______________________####
####_______________________â•‘____ğŸ€«_______ğŸ€™_____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜_____ğŸ€™_______ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_____ğŸ€™___ğŸ€†_____ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†______ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†_____ğŸ€†___ğŸ€™_____ğŸ€«____â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•####
####_______________________â•‘____ğŸ€«___ğŸ€™_______ğŸ€†__ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†____ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†_ğŸ€†__ğŸ€†_______ğŸ€™___ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_ğŸ€™___________ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†__ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___ğŸ€†___________ğŸ€™_ğŸ€«____â•‘_______________________####
####_______________________â•‘____ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«__ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«_ğŸ€«____â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘_________â–©_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–©_________â•‘_______________________####
####_______________________â•‘_________â–¨____________________________________________________â–§_________________________________####
####_______________________â•‘_________â–§____________________________________________________â–¨_________â•‘_______________________####
####_______________________â•‘_________â–¨____________________________________________________â–§_________â•‘_______________________####
####_______________________â•‘_________â–§____________________________________________________â–¨_________â•‘_______________________####
####_______________________â•‘_______à®ƒ_â–¨____________________________________________________â–§_à®ƒ_______â•‘_______________________####
####_______________________â•‘_______Å¦_â–§____________________________________________________â–¨_Å¦_______â•‘_______________________####
##############################################################____##############################################################
##############################################################____##############################################################
"#;

const OOBSIDIAN_WALLS_BOTTOM: &str = r#"
######################################################################################____######################################
######################################################################################____######################################
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨___â–¨__â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨__â–§___â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨___â–¨__â–§________________________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨__â–§___â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨___â–¨__â–§________â•‘_______________________####
####_______________________â•‘_______________________â•‘_______________________â•‘________â–¨_â–©__â–©_â–§________â•‘_______________________####
####â•â•â•â•â•â•â•â•â•â•__â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•__â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•__â•â•â•â•â•â•â•â•â•â•â•________â–¨______â–§________â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•####
####________________________________________________________________________________________________â•‘_______________________####
####________________________________________________________________________________________________â•‘_______________________####
####________________________________________________________________________________________________â•‘_______________________####
####â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_â–¨_________________________________________________________________________â•‘_______________________####
####â–©___â–©___â–©___â–©___â–©___â–©___________________________________________________________________________â•‘_______________________####
__________â–§_______â–§_________________________________________________________________________________________________________####
______â–¨_______â–¨_______â–¨_____________________________________â”Œâ”€â”€â”€â”€â”€â”€â”________________________________â•‘_______________________####
####â–©___â–©___â–©___â–©___â–©___â–©_________________________â•”â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•—______________________â•‘_______________________####
####â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_â–§_______________________â•‘__________________________â•‘______________________â•‘_______________________####
####______________________________________________â•‘__________________________â•‘______________________â•‘_______________________####
####______________________________________________â•‘__________________________â•‘______________________â•‘_______________________####
####______________________________________________â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•______________________â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•####
####â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—________________________________________________________________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘__________________â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜__________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘__________________â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜__________________________________________####
####________________________________________________________________________________________________â•‘_______________________####
####_______________________â•‘__________________â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜__________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘__________________â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜__________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘__________________â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜____â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜__________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘________________________________________________________________________â•‘_______________________####
####_______________________â•‘_________â–©_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–§_â–¨_â–©_________â•‘_______________________####
####_______________________â•‘_________â–¨____________________________________________________â–§_________________________________####
####_______________________â•‘_________â–§____________________________________________________â–¨_________â•‘_______________________####
####_______________________â•‘_________â–¨____________________________________________________â–§_________â•‘_______________________####
####_______________________â•‘_________â–§____________________________________________________â–¨_________â•‘_______________________####
####_______________________â•‘_________â–¨____________________________________________________â–§_________â•‘_______________________####
####_______________________â•‘_________â–§____________________________________________________â–¨_________â•‘_______________________####
##############################################################____##############################################################
##############################################################____##############################################################
"#;

pub fn add_obsidian_walls(mut map: Vec<Vec<Cells>>, left: bool) -> Vec<Vec<Cells>> {
    let walls = match left {
        true => OBSIDIAN_WALLS_BOTTOM,
        false => OBSIDIAN_WALLS_BOTTOM,
        // false => GUILD_WALLS_RIGHT,
        _ => todo!(),
    };

    for (y, line) in walls.lines().skip(1).enumerate() {
        for (x, ch) in line.chars().enumerate() {
            if ch == '_' {
                continue;
            };
            map[y][x] = match ch {
                'â•' => Cells::MwH,
                'â•‘' => Cells::MwV,
                'â•£' => Cells::MwVL,
                'â• ' => Cells::MwVR,
                'â•©' => Cells::MwHU,
                'â•¦' => Cells::MwHD,
                'â•' => Cells::MwUL,
                'â•š' => Cells::MwUR,
                'â•—' => Cells::MwDL,
                'â•”' => Cells::MwDR,
                'â•¤' => Cells::BsHD,
                'â•§' => Cells::BsHU,
                'â”' => Cells::SwDL,
                'â”Œ' => Cells::SwDR,
                'â”˜' => Cells::SwUL,
                'â””' => Cells::SwUR,
                'â”€' => Cells::SwH,
                'â–§' => Cells::Tile1,
                'â–¨' => Cells::Tile2,
                'â–©' => Cells::Tile3,
                '#' => Cells::Wall,
                'Òº' => Cells::ChairRight1,
                'á‚¹' => Cells::ChairRight2,
                'Ğ¶' => Cells::Firewood,
                'à¦Œ' => Cells::FireSmoke,
                'Ü€' => Cells::FireDiamond,
                'à®ƒ' => Cells::FireTri,
                'Å¦' => Cells::Stand1,
                'Å¸' => Cells::Stand2,
                'Å¤' => Cells::Stand3,
                'Æƒ' => Cells::StandBL,
                'ÆŒ' => Cells::StandDL,
                'Æ‚' => Cells::StandBS,
                'Æ‹' => Cells::StandDS,
                'â—' => Cells::CircleVL,
                'â£' => Cells::CircleHex,
                'âŒ¬' => Cells::CircleC,
                'âŒ¹' => Cells::Drawers,
                'âŒ¸' => Cells::Shelves,
                'âš±' => Cells::Vase,
                'ğœ²„' => Cells::LadderV,
                'ğœ²…' => Cells::LadderH,
                'ğœ²' => Cells::TickV,
                'ğœ²‘' => Cells::TickH,
                'á‰‹' => Cells::Tech1,
                'ğŸ»' => Cells::Tech2,
                'ğŸœŸ' => Cells::Tech3,
                'à¬' => Cells::Tech4,
                'Ò¦' => Cells::Tech5,
                'Ò¸' => Cells::Tech6,
                'Ò´' => Cells::Tech7,
                'à±' => Cells::Tech8,
                'ğœ°”' => Cells::Tech9,
                'ğœ°“' => Cells::Tech10,
                'ğœ°‰' => Cells::Tech11,
                'ğœ°Š' => Cells::Tech12,
                'â›€' => Cells::Tech13,
                'â›' => Cells::Tech14,
                'â›‚' => Cells::Tech15,
                'â›ƒ' => Cells::Tech16,
                'á‚©' => Cells::Tech17,
                'á‰–' => Cells::Relic1,
                'á‰·' => Cells::OldWall1,
                'á‰¿' => Cells::OldWall2,
                'á‰¨' => Cells::OldWall3,
                'á‰©' => Cells::OldWall4,
                'á‰­' => Cells::OldWall5,
                'ğŸ€«' => Cells::CardTile1,
                'ğŸ€˜' => Cells::CardTile2,
                'ğŸ€†' => Cells::CardTile3,
                'ğŸ€™' => Cells::CardTile4,
                _ => todo!(),
            };
        }
    }
    map
}

const OBSIDIAN_ITEM_STALLS: [&str; 1] = [OBSIDIAN_ITEM_STALL_1];
const OBSIDIAN_CLINIC_STALLS: [&str; 1] = [OBSIDIAN_CLINIC_STALL_1];
const OBSIDIAN_HERBALIST_STALLS: [&str; 1] = [OBSIDIAN_HERBALIST_STALL_1];
const OBSIDIAN_CANTEEN_STALLS: [&str; 1] = [OBSIDIAN_CANTEEN_STALL_1];
const OBSIDIAN_FILLERS: [&str; 1] = [OBSIDIAN_FILLER_1];
const OBSIDIAN_OFFICES: [&str; 1] = [OBSIDIAN_OFFICE_1];
const OBSIDIAN_DORMS: [&str; 1] = [OBSIDIAN_DORM];

pub fn build_obsidian_settle() -> (
    Vec<Vec<Cells>>,
    HashMap<(usize, usize), NPCWrap>,
    HashMap<(usize, usize), ShopItem>,
    HashMap<(usize, usize), Item>,
    HashMap<(usize, usize), EnvInter>,
    HashMap<(usize, usize), ShopNPC>,
) {
    let mut rng = rand::thread_rng();
    // let cells = vec![vec![Cells::Empty; 128]; 52];
    let face_top = &false;
    // let face_top = [true, false].choose(&mut rng).unwrap_or(&true);
    let mut blocks: Vec<u8> = (1..8).collect();
    blocks.shuffle(&mut rng);

    let (item_map, item_npcs, item_sitems, item_items, item_env_inter, item_shop_npcs) = parse_map(
        OBSIDIAN_ITEM_STALLS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_ITEM_STALLS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Item,
    );
    let (clinic_map, clinic_npcs, clinic_sitems, clinic_items, clinic_env_inter, clinic_shop_npcs) =
        parse_map(
            OBSIDIAN_CLINIC_STALLS
                .choose(&mut rng)
                .unwrap_or(&OBSIDIAN_CLINIC_STALLS[0]),
            vec![vec![Cells::Null; 24]; 12],
            Shops::Null,
        );
    let (
        herbalist_map,
        herbalist_npcs,
        herbalist_sitems,
        herbalist_items,
        herbalist_env_inter,
        herbalist_shop_npcs,
    ) = parse_map(
        OBSIDIAN_HERBALIST_STALLS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_HERBALIST_STALLS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Herbalist,
    );
    let (
        canteen_map,
        canteen_npcs,
        canteen_sitems,
        canteen_items,
        canteen_env_inter,
        canteen_shop_npcs,
    ) = parse_map(
        OBSIDIAN_CANTEEN_STALLS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_CANTEEN_STALLS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Null,
    );
    let (
        filler1_map,
        filler1_npcs,
        filler1_sitems,
        filler1_items,
        filler1_env_inter,
        filler1_shop_npcs,
    ) = parse_map(
        OBSIDIAN_FILLERS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_FILLERS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Null,
    );
    let (
        filler2_map,
        filler2_npcs,
        filler2_sitems,
        filler2_items,
        filler2_env_inter,
        filler2_shop_npcs,
    ) = parse_map(
        OBSIDIAN_FILLERS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_FILLERS[0]),
        vec![vec![Cells::Null; 24]; 12],
        Shops::Null,
    );
    let (office_map, office_npcs, office_sitems, office_items, office_env_inter, office_shop_npcs) =
        parse_map(
            OBSIDIAN_OFFICES
                .choose(&mut rng)
                .unwrap_or(&OBSIDIAN_OFFICES[0]),
            vec![vec![Cells::Null; 24]; 12],
            Shops::Null,
        );
    let (dorm_map, dorm_npcs, dorm_sitems, dorm_items, dorm_env_inter, dorm_shop_npcs) = parse_map(
        OBSIDIAN_DORMS
            .choose(&mut rng)
            .unwrap_or(&OBSIDIAN_DORMS[0]),
        vec![vec![Cells::Null; 24]; 24],
        Shops::Null,
    );

    let (b1_map, b1_npcs, b1_sitems, b1_items, b1_env_inter) = place_obsidion_parts(
        vec![vec![Cells::Null; 128]; 52],
        item_map,
        item_npcs,
        item_sitems,
        item_items,
        item_env_inter,
        blocks[0],
        *face_top,
    );
    let (b2_map, b2_npcs, b2_sitems, b2_items, b2_env_inter) = place_obsidion_parts(
        b1_map.clone(),
        clinic_map,
        clinic_npcs,
        clinic_sitems,
        clinic_items,
        clinic_env_inter,
        blocks[1],
        *face_top,
    );
    let (b3_map, b3_npcs, b3_sitems, b3_items, b3_env_inter) = place_obsidion_parts(
        b2_map.clone(),
        herbalist_map,
        herbalist_npcs,
        herbalist_sitems,
        herbalist_items,
        herbalist_env_inter,
        blocks[2],
        *face_top,
    );
    let (b4_map, b4_npcs, b4_sitems, b4_items, b4_env_inter) = place_obsidion_parts(
        b3_map.clone(),
        canteen_map,
        canteen_npcs,
        canteen_sitems,
        canteen_items,
        canteen_env_inter,
        blocks[3],
        *face_top,
    );
    let (b5_map, b5_npcs, b5_sitems, b5_items, b5_env_inter) = place_obsidion_parts(
        b4_map.clone(),
        filler1_map,
        filler1_npcs,
        filler1_sitems,
        filler1_items,
        filler1_env_inter,
        blocks[4],
        *face_top,
    );
    let (b6_map, b6_npcs, b6_sitems, b6_items, b6_env_inter) = place_obsidion_parts(
        b5_map.clone(),
        filler2_map,
        filler2_npcs,
        filler2_sitems,
        filler2_items,
        filler2_env_inter,
        blocks[5],
        *face_top,
    );
    let (b7_map, b7_npcs, b7_sitems, b7_items, b7_env_inter) = place_obsidion_parts(
        b6_map.clone(),
        office_map,
        office_npcs,
        office_sitems,
        office_items,
        office_env_inter,
        blocks[6],
        *face_top,
    );
    let (b8_map, b8_npcs, b8_sitems, b8_items, b8_env_inter) = place_obsidion_parts(
        b7_map.clone(),
        dorm_map,
        dorm_npcs,
        dorm_sitems,
        dorm_items,
        dorm_env_inter,
        8,
        *face_top,
    );

    let final_map = add_obsidian_walls(b8_map, *face_top);

    let mut final_npcs = HashMap::new();
    let mut final_sitems = HashMap::new();
    let mut final_items = HashMap::new();
    let mut final_env_inter = HashMap::new();
    let mut final_shop_npcs = HashMap::new();
    final_npcs.extend(b1_npcs);
    final_npcs.extend(b2_npcs);
    final_npcs.extend(b3_npcs);
    final_npcs.extend(b4_npcs);
    final_npcs.extend(b5_npcs);
    final_npcs.extend(b6_npcs);
    final_npcs.extend(b7_npcs);
    final_npcs.extend(b8_npcs);
    final_sitems.extend(b1_sitems);
    final_sitems.extend(b2_sitems);
    final_sitems.extend(b3_sitems);
    final_sitems.extend(b4_sitems);
    final_sitems.extend(b5_sitems);
    final_sitems.extend(b6_sitems);
    final_sitems.extend(b7_sitems);
    final_sitems.extend(b8_sitems);
    final_items.extend(b1_items);
    final_items.extend(b2_items);
    final_items.extend(b3_items);
    final_items.extend(b4_items);
    final_items.extend(b5_items);
    final_items.extend(b6_items);
    final_items.extend(b7_items);
    final_items.extend(b8_items);
    final_env_inter.extend(b1_env_inter);
    final_env_inter.extend(b2_env_inter);
    final_env_inter.extend(b3_env_inter);
    final_env_inter.extend(b4_env_inter);
    final_env_inter.extend(b5_env_inter);
    final_env_inter.extend(b6_env_inter);
    final_env_inter.extend(b7_env_inter);
    final_env_inter.extend(b8_env_inter);
    final_shop_npcs.extend(item_shop_npcs);
    final_shop_npcs.extend(clinic_shop_npcs);
    final_shop_npcs.extend(herbalist_shop_npcs);
    final_shop_npcs.extend(canteen_shop_npcs);
    final_shop_npcs.extend(filler1_shop_npcs);
    final_shop_npcs.extend(filler2_shop_npcs);
    final_shop_npcs.extend(office_shop_npcs);
    final_shop_npcs.extend(dorm_shop_npcs);
    (
        final_map,
        final_npcs,
        final_sitems,
        final_items,
        final_env_inter,
        final_shop_npcs,
    )
}

fn place_obsidion_parts(
    mut map: Vec<Vec<Cells>>,
    part: Vec<Vec<Cells>>,
    npcs: HashMap<(usize, usize), NPCWrap>,
    sitems: HashMap<(usize, usize), ShopItem>,
    items: HashMap<(usize, usize), Item>,
    env_inter: HashMap<(usize, usize), EnvInter>,
    block: u8,
    top: bool,
) -> (
    Vec<Vec<Cells>>,
    HashMap<(usize, usize), NPCWrap>,
    HashMap<(usize, usize), ShopItem>,
    HashMap<(usize, usize), Item>,
    HashMap<(usize, usize), EnvInter>,
) {
    let (sx, sy) = if top {
        match block {
            1 => (4, 2),
            2 => (4, 14),
            3 => (4, 26),
            4 => (4, 38),
            5 => (52, 38),
            6 => (76, 38),
            7 => (100, 38),
            8 => (100, 2),
            _ => {
                log::info!("small parts error");
                (0, 0)
            }
        }
    } else {
        match block {
            1 => (4, 2),
            2 => (28, 2),
            3 => (52, 2),
            4 => (100, 2),
            5 => (100, 14),
            6 => (100, 26),
            7 => (100, 38),
            8 => (4, 26),
            _ => {
                log::info!("guild parts error");
                (0, 0)
            }
        }
    };

    for j in 0..part.len() {
        for i in 0..part[0].len() {
            map[j + &sy][i + &sx] = part[j][i];
        }
    }
    let mut new_npcs = HashMap::new();
    for (npos, npc) in npcs {
        new_npcs.insert(((npos.0 + &sx), (npos.1 + &sy)), npc);
    }
    let mut new_sitems = HashMap::new();
    for (ipos, item) in sitems {
        new_sitems.insert(((ipos.0 + &sx), (ipos.1 + &sy)), item);
    }
    let mut new_items = HashMap::new();
    for (ipos, mut item) in items {
        item.set_pos(((ipos.0 + &sx), (ipos.1 + &sy)));
        new_items.insert(((ipos.0 + &sx), (ipos.1 + &sy)), item);
    }
    let mut new_env_inter = HashMap::new();
    for (epos, env) in env_inter.clone() {
        new_env_inter.insert(((epos.0 + &sx), (epos.1 + &sy)), env);
    }

    (map, new_npcs, new_sitems, new_items, new_env_inter)
}
